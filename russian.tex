\documentclass[a4paper,12pt]{article}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{textcase}
\usepackage{dtk-logos}

\usepackage{microtype}
\usepackage{fontspec}
\setmainfont{STIX Two Text}
\setmonofont{PT Mono}[Scale=0.9]
\usepackage[english,russian]{babel}
\usepackage{csquotes}

\usepackage{unicode-math}
\setmathfont{STIX Two Math}

\usepackage[margin=2cm]{geometry}
\usepackage{verbatim}

\usepackage[style=gost-authoryear]{biblatex}
\addbibresource{refs.bib}

\usepackage[xindy,noautomatic]{imakeidx}
\makeindex

\usepackage{tcolorbox}
\tcbuselibrary{skins,listings,minted}
\usemintedstyle{bw}
\tcbset{enhanced,colback=black!5,colframe=black!5,fuzzy shadow={0.5mm}{-0.5mm}{-1.0mm}{0.5mm}{black!50}}
\newtcblisting{latexcode}{listing only,minted language=latex,minted options={fontsize=\footnotesize}}
\newtcblisting{bibtexcode}{listing only,minted language=bibtex,minted options={fontsize=\footnotesize}}
\newtcblisting{latexmkcode}{listing only,minted language=perl,minted options={fontsize=\footnotesize}}
\newtcblisting{makecode}{listing only,minted language=make,minted options={fontsize=\footnotesize}}
\newtcblisting{shcode}{listing only,minted language=shell-session,minted options={fontsize=\footnotesize}}
\newtcblisting{xindycode}{listing only,minted language=lisp,minted options={fontsize=\footnotesize}}


\usepackage[colorlinks,allcolors=blue,hyperindex=false]{hyperref}
\newcommand\foothref[2]{%
  \href{#1}{#2}\footnote{\url{#1}}%
}

\usepackage{fnpct}

\newcommand\package[1]{\texttt{#1}}
\newcommand\exe[1]{\texttt{#1}}
\newcommand\file[1]{\texttt{#1}}

\usepackage{epigraph}

\title{\LaTeX\ в 2017 году}
\author{Сергей Головань}
%\date{22 мая 2017 г.}

\renewcommand\topfraction{1}
\renewcommand\textfraction{0}
\setcounter{topnumber}{5}
\setcounter{totalnumber}{5}

\begin{document}
\maketitle
\tableofcontents

\section{Введение}
Система верстки \TeX\index{tex@\TeX} появилась в конце семидесятых годов прошлого века,
надстройка \LaTeX\index{latex@\LaTeX} --- в 1985 году, и с тех пор является распространённым
инструментом для вёрстки текстов, содержащих математические формулы (да и текст
без формул, свёрстанный с помощью \LaTeX, выглядит очень хорошо благодаря
качественным алгоритмам разбиения абзацев на строки). Оригинальный компилятор
\TeX\ на сегодняшний момент зафиксирован и не развивается, но несмотря на это
в мире \TeX\ происходит довольно много изменений в последние годы. Появляются
новые компиляторы (\XeTeX\index{xetex@\XeTeX}, \LuaTeX\index{luatex@\LuaTeX}), направленные
на более удобное использование
современных форматов шрифтов, на совершенствование поддержки многоязычных
документов. Совершенствуются вспомогательные средства (для обработки
библиографии, создания предметных указателей). В данной заметке я хочу
перечислить несколько своих решений о применении того или иного инструмента,
которые мне представляются разумными в 2017 году.

\section{Кодировка: UTF-8}
Я познакомился с \LaTeX, будучи пользователем операционной системы MS DOS,
поэтому первой кириллической кодировкой для моих текстов была так называемая
альтернативная кодовая страница или CP866. Потом появился GNU/Linux и кодировка
KOI8-R, а потом оказалось, что обмениваться исходными текстами в этой кодировке
неудобно, так как все вокруг пользуются MS Windows, поэтому я перешел на
CP1251 (у которой по сравнению с KOI8-R есть и другие преимущества, такие как
более удобный набор символов). Однако если в тексте попадается какой-нибудь
нестандартный символ или слово (греческое, китайский иероглиф и т.\,п.), то
приходилось исхитряться, чтобы его набрать. Для европейских языков Дональд Кнут
предусмотрел ввод акцентов (\verb|u\v{z}ivatel| даёт u\v{z}ivatel), а что с
остальными? Всё изменилось с распространением юникодной кодировки UTF-8. Сейчас
она уже самая распространённая среди пользователей GNU/Linux и MacOS X,
а пользователю MS Windows вполне можно рекомендовать какой-нибудь удобный
редактор для \TeX, например \foothref{http://www.xm1math.net/texmaker/}{TeXmaker}
или \foothref{http://texstudio.sourceforge.net/}{TeXstudio} с её поддержкой.

Так что в данном случае выбор однозначный --- UTF-8. \LuaTeX\ и \XeTeX\ поддерживают
UTF-8 «из коробки» как основную и единственную кодировку (\LuaLaTeX\ можно
заставить работать с восьмибитными документами, но зачем?), обычный \TeX\
и \pdfTeX\ с UTF-8 работают просто как с потоком отдельных байтов, так что
для поддержки UTF-8 в \LaTeX\ необходимо подключать пакет \package{inputenc}
с опцией \verb|[utf8]|.

\section{Компилятор: \LuaTeX\ и формат \LuaLaTeX}
У меня как у русскоязычного пользователя \TeX\ не возникало нужды рассматривать
такие экзотические компиляторы, как p\TeX, созданный для качественной печати японских
текстов, но и без него существует много разных вариантов \TeX\ --- \eTeX, \pdfTeX,
\XeTeX, \LuaTeX\ и масса других. Прежде всего они отличаются
друг от друга
\begin{itemize}
\item форматом исходящего документа (DVI или PDF),
\item поддержкой юникодных кодировок,
\item общей возможностью использования системных ресурсов (в оригинальном \TeX,
скажем, было всего 256 числовых регистров),
\item поддержкой разных форматов шрифтов.
\end{itemize}

Если говорить про выбор DVI против PDF, то единственное, чего мне некоторое время
не хватало в PDF по сравнению со связкой $\text{DVI}\to\text{PS}\to\text{PDF}$,
это пакета \package{psfrag}, вставляющего надписи в иллюстрации. Однако с тех
пор и векторные редакторы (скажем, \foothref{https://inkscape.org/en/}{Inkscape})
научились вставлять надписи,
отформатированные в \LaTeX, и появились удобные неинтерактивные средства создания
иллюстраций (например, \foothref{http://asymptote.sourceforge.net/}{Asymptote}),
так что нужда в \package{psfrag}
отпала. А поскольку сам по себе формат DVI непереносим (иллюстрации не
внедряются, шрифты не внедряются), то получается, что лучшим форматом на данный
момент является PDF. В этом формате выдают результат \pdfTeX, \XeTeX, \LuaTeX.
Дополнительным преимуществом компиляторов, выводящим результат непосредственно в PDF,
является поддержка микротипографических расширений с помощью пакета
\foothref{https://www.ctan.org/pkg/microtype}{\package{microtype}}.


Так как я предпочитаю новые документы создавать в кодировке UTF-8, то хорошо было
бы, чтобы компилятор мог с ней работать. \pdfTeX\ работает с текстом как с потоком
байтов, поэтому поддержку UTF-8 приходится реализовывать внутри макропакета \LaTeX.
Это делает
\foothref{https://tex.stackexchange.com/questions/13067/utf8x-vs-utf8-inputenc}{\package{inputenc}}.
Минусом данного решения является то, что, скажем,
при составлении предметного указателя вспомогательный файл со списком слов
вместо русских букв содержит списки макросов вроде \verb|\IeC {\cyro }|,
а значит для его обработки программой создания указателя необходимо заменить
все эти макросы на буквы. Это несложно, но создаёт некоторые неудобства.
\XeTeX\ и \LuaTeX\ поддерживают UTF-8 изначально, поэтому с этой точки зрения
они предпочтительнее.

\pdfTeX, как и обычный \TeX, требует наличия отдельных метрик шрифтов в виде
файлов формата TFM. Этот формат весьма ограничен, в частности он поддерживает не
более 256 символов в одном шрифте. Поэтому многоязычная работа становится не
слишком удобной. Приходится переключать кодировку шрифта для фраз на других
языках. \XeTeX\ и \LuaTeX\ способны работать со шрифтами в формате TTF и OTF
непосредственно, а в них число символов практически не ограничено. Но в
данном аспекте мне больше нравится \LuaTeX, который с помощью пакета
\package{luaotfload} может подключать шрифты, расположенные в дереве
дистрибутива \TeX, по их названиям, а не только по
именам файлов как для \XeTeX. Это делает его более переносимым между
платформами.

Следует отметить, что \LuaTeX\ довольно молодой проект, поэтому в нём еще
встречаются ошибки. Так, например, неправильное расположение пределов
интегрирования при использовании \package{unicode-math} починили совсем недавно,
в версии 1.0. Также \LuaTeX\ существенно медленнее, чем \pdfTeX, особенно в части
загрузки шрифтов. Впрочем, потеря нескольких секунд на документ не кажется мне
существенным недостатком.

Таким образом, несмотря на отдельные недостатки, по совокупности доставляемых
удобств на данный момент я выбираю компилятор \LuaTeX.

\section{Набор математики: unicode-math?}
С тех пор, как в Unicode включили массу математических символов, а потом с
помощью компании Microsoft в спецификации формата шрифтов OTF
появилась таблица MATH, в \LuaLaTeX\ и \XeTeX\ реализовали альтернативный
способ верстки математических формул --- посредством пакета
\foothref{https://www.ctan.org/pkg/unicode-math}{\package{unicode-math}}%
.\index{набор математики}
Также начали разрабатываться шрифты с поддержкой юникодной математики. Примеры таких
шрифтов: \emph{Latin Modern Math}, \emph{Asana Math}, \emph{STIX Math},
\emph{XITS Math} и другие (в данном документе есть формула, набранная
шрифтом \emph{STIX Two Math}).
При этом традиционный метод вёрстки математических формул не исчез, что
очень радует, так как всё-таки \package{unicode-math} в сочетании со шрифтами
Computer Modern (или их клонами) пока еще выглядит не вполне хорошо.
Также старым способом приходится пользоваться для набора, скажем, шрифтом
Euler, который мне тоже нравится. Сам процесс набора с помощью \package{unicode-math}
мало отличается от обычного --- те же команды. Но некоторые удобства всё-таки
есть. В частности, не нужно больше использовать разрозненный набор команд
печати всевозможных полужирных вариантов начертания: \verb|\mathbf|, \verb|\boldkey|,
\verb|\boldsymbol|. Переключение происходит командами с естественными именами:
\verb|\symbfup|, \verb|\symbfit| (для прямого и курсивного вариантов), причём
действуют и на греческие буквы.

В общем и целом на данный момент я пользуюсь традиционным набором математики,
если использую шрифты \emph{Computer Modern}, \emph{Euler} или другие старые шрифты, но
применяю \package{unicode-math} для гарнитур вроде \emph{STIX Two Math} или
\emph{Libertinus Math}.

\section{Пакет локализации: babel}
Сейчас существует два распространённых пакета, которые отвечают за
локализацию документа ---
\foothref{https://www.ctan.org/pkg/babel}{\package{babel}} и
\foothref{https://www.ctan.org/pkg/polyglossia}{\package{polyglossia}}.\index{локализация}
Первый из них это старый заслуженный пакет, работающий со всеми
вариантами \TeX\ (поддержка динамической загрузки образцов для
переноса слов, которая применяется в \LuaTeX, появилась относительно
недавно). Второй --- молодой пакет, работающий в \XeLaTeX\ и в \LuaLaTeX.
При этом \package{polyglossia} не поддерживает шрифты в старых кодировках,
например в традиционной кириллической кодировке T2A. С другой стороны
пользовательский интерфейс у \package{polyglossia} мне нравится чуть больше,
чем у \package{babel}, он ближе к интерфейсу пакета \package{fontspec}
выбора шрифтов, который я рассмотрю позже. На рисунках~\ref{babel1}--\ref{polygl1}
\begin{figure}[tp]
\begin{latexcode}
\usepackage[T2A]{fontenc}
\usepackage[utf8]{luainputenc}
\usepackage[english,russian]{babel}
\end{latexcode}
\caption{Подключение пакета \package{babel} для работы со старой кодировкой шрифта}\label{babel1}
\end{figure}
\begin{figure}[tp]
\begin{latexcode}
\usepackage[english,russian]{babel}
\end{latexcode}
\caption{Подключение пакета \package{babel} для работы с новой юникодной кодировкой шрифта}\label{babel2}
\end{figure}
\begin{figure}[tp]
\begin{latexcode}
\usepackage{polyglossia}
\setmainlanguage{russian}
\setotherlanguage{english}
\end{latexcode}
\caption{Подключение пакета \package{polyglossia}}\label{polygl1}
\end{figure}
приведены примеры подключения этих пакетов.

Какой же из них выбрать? Увы, на данный момент в пакете \package{polyglossia}
существует досадный \foothref{https://github.com/reutenauer/polyglossia/issues/24}{баг
с непереключением шрифта} при переходе в математический
режим (а также при печати внеполосных элементов, таких как номера страниц),
проявляющийся в русскоязычных текстах (и в греческих, кстати, также).
{\itshape Если текст набирается курсивом, то номера выносных формул
\begin{equation}
e^x=\sum_{n=0}^\infty\frac{x^n}{n!},\tag*{\textit{(1)}}
\end{equation}
увы, тоже получаются курсивными. А также номера страниц и сноски, попавшие
в разрыв с курсивом до и после него.}

Поэтому на данный момент я выбираю пакет \package{babel}, но продолжаю время
от времени посматривать на \package{polyglossia}.

\section{Шрифты: fontspec}
Подключение шрифтов к оригинальному \TeX\ всегда было делом непростым.
То есть, конечно же, были шрифты, написанные на \METAFONT\ специально для
\TeX, но сейчас можно смело сказать, что этот формат умер, и пользоваться
им довольно бессмысленно. Подключение же других форматов требует
дополнительной работы --- создания метрических файлов TFM, перекодировки
шрифта в одну или несколько 8-битных кодировок, поддерживаемых в \TeX,
и генерирования файла соответствия полученного внутреннего имени шрифта
оригинальному шрифтовому файлу.

\XeTeX\ и \LuaTeX\ позволяют исключить все эти этапы и работают
непосредственно со шрифтами в форматах TTF и OTF (впрочем, старые
шрифты им всё ещё доступны, так что переписывать все старые документы для
их обработки \LuaLaTeX\ не придётся). Для удобства подключения шрифтов
предназначен пакет \foothref{https://www.ctan.org/pkg/fontspec}{\package{fontspec}}.
На рис.~\ref{fontspec1}
\begin{figure}[tp]
\begin{latexcode}
\usepackage{fontspec}
\setmainfont{STIX Two Text}[Ligatures=TeX]
\setmonofont{PT Mono}[Scale=0.9]
\end{latexcode}
\caption{Подключение шрифтов с использованием
\package{fontspec}}\label{fontspec1}
\end{figure}
приведён пример такого подключения. При этом пакет обладает большой
гибкостью, при использовании шрифта можно учитывать его дополнительные
свойства: различного рода лигатуры, варианты написания отдельных
символов и т.~п. Также \package{fontspec} сам реализует некоторые
возможности, такие как масштабирование шрифта, дополнительные наборы
лигатур (привычных пользователям \TeX, таких как
$\verb|---|\mapsto\text{---}$ или $\verb|<<>>|\mapsto\text{<<>>}$)
и ещё массу всяких нужных и не очень.

Поэтому в данном случае мой выбор такой: Если не требуется использование
старых шрифтов, которые недоступны в формате OTF (например, бесплатный
шрифт Литературной гарнитуры есть только в формате Type1), то я выбираю
\package{fontspec} как средство управления шрифтами.

\section{Библиография: biblatex и biber}
Исторически первым инструментом для автоматического построения
списка литературы стал \foothref{http://www.bibtex.org/}{\BibTeX}. При его
использовании источники
помещаются в отдельный файл (см. рис.~\ref{bibfile}).
\begin{figure}[tp]
\begin{bibtexcode}
@book{yolkin1997,
  title={Редукция нелинейных управляемых систем.
         Дифференциально"=геометрический подход},
  author={Ёлкин, Владимир Иванович},
  pagetotal={320},
  year={1997},
  location={M.},
  publisher={Наука},
  langid={russian},
}

@book{esin1950,
  title={Физическая химия пирометаллургических процессов},
  author={Есин, Олег Алексеевич},
  year={1950},
  location={M.},
  publisher={Государственное научно-техническое издательство
             литературы по черной и цветной металлургии},
  langid={russian},
}

@book{eliseeva2010,
  title={Статистика},
  author={Елисеева, Ирина Ильинична},
  year={2010},
  publisher={Издательский дом «Питер»},
  langid={russian},
}

@book{chebyshev1859,
  title={О правѣ наказанія: Рѣчь, произнесенная в торжественном
         собраніи Демидовскаго лицея 29 ноября, 1859 года},
  author={Чебышев-Дмитриев, Александр},
  url={http://books.google.it/books?id=uCYYAAAAYAAJ},
  year={1859},
  publisher={Фальк},
  langid={russian},
}
\end{bibtexcode}
\caption{Файл с источниками для списка литературы}\label{bibfile}
\end{figure}
Далее при каждом использовании команды~\verb|\cite{key}| соответствующая
ссылка записывается и отдельная утилита \package{bibtex} собирает эти
ссылки и формирует библиографию в соответствии с выбранным стилем оформления.
В частности, список может быть отсортирован по алфавиту, по году
публикации, в порядке цитирования и т.\,п.
(На рис.~\ref{bibliography} приведены команды, выбирающие стиль
\begin{figure}[tp]
\begin{latexcode}
\bibliographystyle{plainnat}
\bibliography{referencesfile}
\end{latexcode}
\caption{Печать списка литературы с помощью \BibTeX}\label{bibliography}
\end{figure}
\begin{figure}[tp]
\begin{latexcode}
\usepackage[style=gost-authoryear]{biblatex}
\addbibresource{referencesfile.bib}

...

\printbibliography
\end{latexcode}
\caption{Печать списка литературы с помощью \package{biblatex}}\label{biblatex1}
\end{figure}
списка литературы и собственно печатающая его.)
К сожалению, в своём оригинальном виде \BibTeX\ предназначается только
для работы с англоязычной литературой в кодировке ASCII (то, что
он как-то работает с восьмибитными кодировками --- счастливая случайность,
а то что в кодировке CP1251 ещё и сортировка по алфавиту работает,
кроме буквы Ё, это ещё одна приятная, но неожиданность). Поддержку различных
8-битных кодировок имеет
\foothref{https://www.ctan.org/tex-archive/biblio/bibtex/8-bit}{\exe{bibtex8}},
однако подготовить с его помощью
список литературы с источниками, скажем, на русском и греческом языках
не удастся, так как вместе эти языки не помещаются в одну кодировку, а
использовать для разных источников разные кодировки программа не может.
Есть, однако, вариант и с поддержкой UTF-8, называется
\foothref{https://tex.stackexchange.com/questions/169286/how-do-i-get-bibtexu-working}{\exe{bibtexu}},
--- проект недокументированный, и судя по всему, недописанный, так как
добиться правильной сортировки по алфавиту русскоязычных книг с ним
не удалось. Таким образом, \BibTeX\ и его усовершенствованные аналоги
плохо подходят для формирования многоязычного списка литературы.

К счастью, существует хорошая альтернатива: пакет
\foothref{https://tex.stackexchange.com/questions/13509/biblatex-in-a-nutshell-for-beginners}{\package{biblatex}}
для печати списка литературы и
\foothref{http://biblatex-biber.sourceforge.net/}{\exe{biber}}
в качестве обработчика файла с источниками.
Пакет \package{biblatex} отвечает за печать библиографии и позволяет
это делать очень гибко. Настраивается почти всё, и для него доступно большое
количество готовых стилей, включая ГОСТ. На рис.~\ref{biblatex1}
приведены
команды, подключающие список литературы и печатающие его. На рисунке~\ref{biblatex2}%
\nocite{yolkin1997,esin1950,eliseeva2010,chebyshev1859}%
\index{Елисеева}%
\index{Ёлкин}%
\index{Есин}
\begin{figure}[tp]
\begin{tcolorbox}[colback=white,colframe=white]
\centering
\small
\printbibliography
\end{tcolorbox}
\caption{Список литературы, выведенный с помощью \package{biblatex} и \exe{biber}}\label{biblatex2}
\end{figure}
показан результат.
\exe{biber} способен работать и с 8-битными кодировками, но по умолчанию
используется кодировка UTF-8, что позволяет удобно обрабатывать многоязычные
базы литературных источников, при этом не возникает проблем с корректной сортировкой
(как видно из примера на рис.~\ref{biblatex2}, многострадальная буква Ё
сортируется правильно --- вместе~с~Е) и выделением инициалов, в то время как
тот же \exe{bibtex} не может без специальных ухищрений правильно отделить
инициалы от имени и отчества, так как они в UTF-8 для кириллицы составляют не
один байт, а~два.

Таким образом, для печати списка литературы я на данный момент предпочитаю
\package{biblatex} и \exe{biber}.

\section{Предметный указатель: xindy}
\epigraph{Живут на ёлках\index{ёлка} белки, хоть ёлки и не елки\index{елка}.}{А. А. Милн, \emph{Винни-Пух и все-все-все}}
Печать предметного указателя в \LaTeX\ делается в два этапа. На первой стадии
командами \verb|\index{}| собирается информация об элементах списка,
на второй стадии они обрабатываются с помощью внешней программы, после
чего уже печатаются. Типичный пример~--- использование пакета
\foothref{https://www.ctan.org/pkg/imakeidx}{\package{imakeidx}},
с которым \verb|\makeindex| открывает файл \file{docname.idx}, далее
обработка \foothref{https://www.ctan.org/pkg/makeindex}{\package{makeindex}}
\file{docname.idx} превращает его в \file{docname.ind},
который уже включается в тело документа с помощью команды \verb|\printindex|.

Как обычно, в \exe{makeindex} не предусмотрены никакие кодировки, кроме ASCII,
поэтому чтобы его применить к индексу на русском языке, приходилось прибегать
к разным ухищрениям (из подобных обёрток вырос
\foothref{https://www.ctan.org/tex-archive/macros/latex/contrib/t2/etc/rumkidx}{\exe{rumakeindex}}
когда-то). Ну и конечно
же работа в кодировке UTF-8 в \exe{makeindex} невозможна тоже без предварительного
перекодирования и потом перекодирования результирующего файла обратно. А это
весьма неудобно.

Альтернативное средство обработки предметных указателей (а также других списков,
например, глоссариев) --- \foothref{https://www.ctan.org/pkg/xindy}{\exe{xindy}}
появилось, когда стало ясно, что
\exe{makeindex} не удаётся адаптировать к многоязычным документам.

\exe{xindy} --- очень мощная программа, она позволяет задавать правила
сортировки списков и объединения их в группы (по первой букве или другими
способами) очень гибко. Кроме того, никаких проблем не возникает при работе
в кодировке UTF-8. Однако поставляемые по умолчанию наборы правил
сортировки, к сожалению, не очень подходят к многоязычным документам
с разными алфавитами (например, кириллицей и латиницей). Дело в том, что
сортировка проводится посредством отображения алфавита в некие списки
байтов (которые потом и сортируются), и эти списки для латиницы и кириллицы
заданы жестко и перекрываются. То есть, некоторые русские и английские буквы
объединяются в группы, которые разделить невозможно. Поэтому для многоязычного
предметного указателя приходится самостоятельно сооружать список правил для
сортировки (пример таких правил для русского и английского языков см.\ на
рис.~\ref{xindy1}).
\begin{figure}[tp]
\begin{xindycode}
(define-letter-groups ("А" "Б" "В" "Г" "Д" "Е" "Ж" "З" "И" "Й" "К"
    "Л" "М" "Н" "О" "П" "Р" "С" "Т" "У" "Ф" "Х" "Ц" "Ч" "Ш" "Щ" "Ъ"
    "Ы" "Ь" "Э" "Ю" "Я" "A" "B" "C" "D" "E" "F" "G" "H" "I" "J" "K"
    "L" "M" "N" "O" "P" "Q" "R" "S" "T" "U" "V" "W" "X" "Y" "Z"
    ))

(define-rule-set "alphabetize"
  :rules (("а" "А") ("б" "Б") ("в" "В") ("г" "Г") ("д" "Д") ("е" "Е")
          ("Ё" "Е") ("ё" "Е") ("ж" "Ж") ("з" "З") ("и" "И") ("й" "Й")
          ("к" "К") ("л" "Л") ("м" "М") ("н" "Н") ("о" "О") ("п" "П")
          ("р" "Р") ("с" "С") ("т" "Т") ("у" "У") ("ф" "Ф") ("х" "Х")
          ("ц" "Ц") ("ч" "Ч") ("ш" "Ш") ("щ" "Щ") ("ъ" "Ъ") ("ы" "Ы")
          ("ь" "Ь") ("э" "Э") ("ю" "Ю") ("я" "Я") ("a" "A") ("b" "B")
          ("c" "C") ("d" "D") ("e" "E") ("f" "F") ("g" "G") ("h" "H")
          ("i" "I") ("j" "J") ("k" "K") ("l" "L") ("m" "M") ("n" "N")
          ("o" "O") ("p" "P") ("q" "Q") ("r" "R") ("s" "S") ("t" "T")
          ("u" "U") ("v" "V") ("w" "W") ("x" "X") ("y" "Y") ("z" "Z")
          ))

(define-rule-set "reorderyo"
  :rules (("Е" "8") ("е" "8") ("Ё" "9") ("ё" "9")
	  ))

(define-rule-set "ignore-special"
  :rules (("?" "") ("." "") ("-" "") ("'" "") ("!" "") ("{" "") ("}" "")
          ))

(define-sort-rule-orientations (forward forward))
(use-rule-set :run 0
	      :rule-set ("alphabetize" "ignore-special"))
(use-rule-set :run 1
	      :rule-set ("reorderyo" "ignore-special"))
\end{xindycode}
\caption{Список правил \file{ruseng.xdy} для русско-английского указателя
\exe{xindy}}\label{xindy1}
\end{figure}
В этом наборе сортировка происходит независимо от регистра букв, кроме того, буквы
Е и Ё сортируются вместе (но не вперемешку, в одинаковых словах Ё идёт после Е,
как на рис.~\ref{xindy4}).
\begin{figure}[tp]
\begin{tcolorbox}[colback=white,colframe=white]
\centering
\small
\vspace*{-2ex}
\printindex
\end{tcolorbox}
\caption{Предметный указатель, выведенный с помощью \package{imakeidx} и
\exe{xindy}}\label{xindy4}
\end{figure}
Хотелось бы также отметить, что \exe{xindy} полезна не только тем, кто пользуется
\LuaLaTeX\ или \XeTeX\ (и как следствие их файлы \file{.idx} содержат именно русские буквы),
но и пользователям \pdfLaTeX, у которых в \file{.idx} кириллица выглядит как набор макросов
вроде \verb|\IeC {\cyrp }|. Так, добавление строки
\verb|(merge-rule "\IeC {\cyrp }" "п" :string)| в приведённый на рис.~\ref{xindy1} список правил
включит обработку строчной буквы П, записанной в таком экзотическом виде. А~для тех, кто
еще пользуется 8-битными кодировками в поставке \exe{xindy} есть готовые наборы правил
вроде \file{tex/inputenc/cp1251}.
На рисунках~\ref{xindy2} и~\ref{xindy3}
\begin{figure}[tp]
\begin{latexcode}
\usepackage[xindy,noautomatic]{imakeidx}
\makeindex

...

Живут на ёлках\index{ёлка} белки, хоть ёлки и не елки\index{елка}.

...

\printindex
\end{latexcode}
\caption{Предметный указатель в тексте документа}\label{xindy2}
\end{figure}
\begin{figure}[tp]
\begin{shcode}
% lualatex doc.tex

...

% texindy -M ruseng doc.idx

...

% lualatex doc.tex

...

%
\end{shcode}
\caption{Компиляция документа с предметным указателем}\label{xindy3}
\end{figure}
можно увидеть, как именно программируется
предметный указатель в тексте, и как он подключается в два прохода.

\section{Система сборки: latexmk}
Строго говоря, система сборки нужна не всегда. Для случаев одиночных коротких
документов без оглавления, библиографии и т.~п. без нее вполне можно
обойтись. А вот если библиография, предметный указатель, перекрёстные
ссылки в документе есть, то система сборки, позволяющая не думать, сколько
раз запускать компилятор, \exe{biber}, \exe{xindy}, существенно
повышает удобство использования \LaTeX. Для особо сложных случаев, когда
в одном проекте нужны разные компиляторы \LaTeX\ (есть у меня ещё такие со
стародавних времен), я использую
\foothref{https://www.gnu.org/software/make/}{GNU \exe{make}}
с довольно громоздким \file{Makefile}. Но для новых проектов гораздо
более удобным представляется
\foothref{https://www.ctan.org/pkg/latexmk}{\exe{latexmk}}
с небольшим файлом конфигурации. В частности, данный документ успешно
собирается одной командой, представленной на рисунке~\ref{latexmk1},
\begin{figure}[tp]
\begin{shcode}
% latexmk russian.tex

...

%
\end{shcode}
\caption{Компиляция документа с помощью \exe{latexmk}}\label{latexmk1}
\end{figure}
с использованием конфигурационного файла с рисунка~\ref{latexmk2}.
\begin{figure}[tp]
\begin{latexmkcode}
$pdf_mode = 1;
$pdflatex = 'lualatex %O %S';
$makeindex = 'texindy -M ruseng.xdy %O %S';
$bibtex = 'biber %O %B'
\end{latexmkcode}
\caption{Конфигурационный файл \file{latexmkrc}}\label{latexmk2}
\end{figure}
В результате запуска \exe{latexmk} компилятор запускается несколько раз,
в промежутках вспомогательные файлы обрабатываются с помощью \exe{biber}
и \exe{xindy} (при необходимости).

Впрочем, если проект достаточно сложный, с рисунками, которые генерируются
из исходных текстов разными способами (например, \file{figure1.pdf}
получается из \file{figure1.asy} запуском \verb|asy -f pdf figure1.asy|,
а \file{figure2.pdf} получается каким-нибудь другим способом, скажем
запуском \verb|Rscript figure2.r|), то объяснить \exe{latexmk}, что и как
надо запускать, становится нетривиально. Так что старый добрый \exe{make}
ещё послужит. Особенно в комбинации с \exe{latexmk}, то есть с правилом,
подобным представленному на рисунке~\ref{latexmk3}.
\begin{figure}[tp]
\begin{shcode}
...

%.pdf: %.tex
        latexmk -lualatex $<

...
\end{shcode}
\caption{Отрывок \file{Makefile} с использованием
\exe{latexmk}}\label{latexmk3}
\end{figure}

\section{Средство для совместной работы: Git, Fossil}
Документы не всегда пишутся одним автором, часто над текстом работает несколько
человек. Поэтому системы для совместной работы существенно повышают удобство работы
над статьями, книгами и т.\,п. Это системы, позволяющие легко объединять фрагменты
текста, возвращаться к предыдущим вариантам и т.\,п. Более того, даже для одного автора
такие системы весьма удобны.

В настоящее время существуют облачные (онлайновые) сервисы для совместной работы с
документами в \LaTeX{}. Два примера:
\begin{itemize}
  \item \foothref{https://www.overleaf.com}{\textbf{Overleaf}}
  \item \foothref{https://www.sharelatex.com}{\textbf{ShareLaTeX}}
\end{itemize}
Оба сервиса работают прямо в Интернет-браузере, не требуют установки дистрибутива
\LaTeX{} на локальный компьютер. Некоторые интересные возможности их доступны только
для платных подписчиков, скажем, собственно совместная работа в \textbf{ShareLaTeX}.
\textbf{Overleaf} в этом смысле меньше ограничивает, но, например, бесплатным
подписчикам не позволяется создавать закрытые совместные проекты, что иногда
хотелось бы. Ну и лично для меня неудобно то, что редактирование происходит в
браузере, то есть мне приходится подстраиваться под местный текстовый редактор
вместо того, чтобы пользоваться привычным мне. Ну и требование наличия довольно
быстрого канала в Интернет тоже не слишком приятно.

Другой класс систем совместной работы это системы управления версиями (Version
Control Systems). Их изобрели для работы с исходным кодом программ, но так как
\LaTeX{} работает с обычными текстовыми файлами на входе, то оказалось, что
системы управления версиями прекрасно справляются с документами \LaTeX{}.

Систем управления версиями существует огромное количество. Какую предпочесть?
Первый критерий --- распределённость. На текущий момент централизованную систему
я бы не стал выбирать (в конце концов наличие полной копии репозитория на каждом
рабочем компьютере играет роль своеобразной резервной копии, которых мало не
бывает). Второй критерий --- популярность, чем более распространена система, тем проще
найти для неё хостинг. Далее, пожалуй, любая система подойдёт, все они предоставляют
схожий интерфейс и примерно одинаковый перечень возможностей. На сегодняшний момент
лидером по распространённости является \foothref{https://git-scm.com}{Git}.
Хостинг для него можно найти, например, на \foothref{https://github.com}{Github},
\foothref{https://bitbucket.org}{Bitbucket}, \foothref{https://gitlab.com}{Gitlab}
и многие другие. Какие-то из них предоставляют возможность создания закрытых
репозиториев бесплатно, другие нет.

Кроме того, для небольших проектов (в основном единолично разрабатываемых) я использую
\foothref{https://fossil-scm.com}{Fossil}. Он намного проще в установке, чем Git,
если репозиторий не размещать на публичном хостинге (то есть использовать вовсе без
хостинга или самостоятельно поддерживать), то он удобнее, так как формат самого
репозитория --- база данных \foothref{https://sqlite.org}{SQLite} (в отличие от
формата репозитория Git --- развесистого дерева поддиректорий с файлами). Соответственно,
для него удобно создавать резервные копии, его можно размещать на каком-нибудь сетевом
ресурсе вроде \foothref{https://dropbox.com}{Dropbox} или
\foothref{https://owncloud.org}{OwnCloud} (своеобразный хостинг для бедных).

\end{document}

\section{Пример документа}
\begin{figure}[tp]
\footnotesize
\begin{verbatim}
\documentclass{article}
\usepackage{microtype}
\usepackage{fontspec}
\setmainfont{STIX Two Text}[Ligatures=TeX]
\usepackage{unicode-math}
\setmathfont{STIX Two Math}
\usepackage[english,russian]{babel}
\usepackage[xindy,noautomatic]{imakeidx}
\makeindex
\usepackage[style=gost-authoryear]{biblatex}
\addbibresource{referencesfile.bib}

\title{Название статьи}
\author{А. В. Тор}

\begin{document}
\section{Введение}
\section{Основной результат}
\section{Заключение}
\printbibliography
\printindex
\end{document}
\end{verbatim}
\caption{Пример законченного документа}\label{docexample}
\end{figure}
\begin{figure}[tp]
\footnotesize
\begin{verbatim}
% lualatex doc.tex

...

% # обрабатываем список литературы
% biber doc

...

% # на случай, если разрывы между страницами изменятся после обработки ссылок
% lualatex doc.tex

...

% # собираем предметный указатель
% texindy -M ruseng doc.idx

...

% # подключаем литературу и предметный указатель
% lualatex doc.tex

...

%
\end{verbatim}
\caption{Пример сессии}\label{sessionexample}
\end{figure}
\end{document}

